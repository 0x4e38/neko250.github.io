<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<title>blackenergy</title>


<style type="text/css">
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA09pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoMTMuMCAyMDEyMDMwNS5tLjQxNSAyMDEyLzAzLzA1OjIxOjAwOjAwKSAgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUM2NjlDQjI4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUM2NjlDQjM4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5QzY2OUNCMDg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5QzY2OUNCMTg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsQhXeAAAABfSURBVHjaYvz//z8DJYCRUgMYQAbAMBQIAvEqkBQWXI6sHqwHiwG70TTBxGaiWwjCTGgOUgJiF1J8wMRAIUA34B4Q76HUBelAfJYSA0CuMIEaRP8wGIkGMA54bgQIMACAmkXJi0hKJQAAAABJRU5ErkJggg==) no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0;
}

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }
li {
  margin: 0; }
ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0;border-collapse: collapse; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
}
</style>

<style type="text/css">
/**
 * prism.js tomorrow night eighties for JavaScript, CoffeeScript, CSS and HTML
 * Based on https://github.com/chriskempson/tomorrow-theme
 * @author Rose Pritchard
 */

code[class*="language-"],
pre[class*="language-"] {
	color: #ccc;
	background: none;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;

}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #2d2d2d;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.block-comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: #999;
}

.token.punctuation {
	color: #ccc;
}

.token.tag,
.token.attr-name,
.token.namespace,
.token.deleted {
	color: #e2777a;
}

.token.function-name {
	color: #6196cc;
}

.token.boolean,
.token.number,
.token.function {
	color: #f08d49;
}

.token.property,
.token.class-name,
.token.constant,
.token.symbol {
	color: #f8c555;
}

.token.selector,
.token.important,
.token.atrule,
.token.keyword,
.token.builtin {
	color: #cc99cd;
}

.token.string,
.token.char,
.token.attr-value,
.token.regex,
.token.variable {
	color: #7ec699;
}

.token.operator,
.token.entity,
.token.url {
	color: #67cdcc;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}

.token.inserted {
	color: green;
}
</style>

<style type="text/css">
pre.line-numbers {
	position: relative;
	padding-left: 3.8em;
	counter-reset: linenumber;
}

pre.line-numbers > code {
	position: relative;
}

.line-numbers .line-numbers-rows {
	position: absolute;
	pointer-events: none;
	top: 0;
	font-size: 100%;
	left: -3.8em;
	width: 3em; /* works for line-numbers below 1000 lines */
	letter-spacing: -1px;
	border-right: 1px solid #999;

	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	user-select: none;

}

	.line-numbers-rows > span {
		pointer-events: none;
		display: block;
		counter-increment: linenumber;
	}

		.line-numbers-rows > span:before {
			content: counter(linenumber);
			color: #999;
			display: block;
			padding-right: 0.8em;
			text-align: right;
		}
</style>

<style type="text/css">
div.prism-show-language {
	position: relative;
}

div.prism-show-language > div.prism-show-language-label {
	color: black;
	background-color: #CFCFCF;
	display: inline-block;
	position: absolute;
	bottom: auto;
	left: auto;
	top: 0;
	right: 0;
	width: auto;
	height: auto;
	font-size: 0.9em;
	border-radius: 0 0 0 5px;
	padding: 0 0.5em;
	text-shadow: none;
	z-index: 1;
	-webkit-box-shadow: none;
	-moz-box-shadow: none;
	box-shadow: none;
	-webkit-transform: none;
	-moz-transform: none;
	-ms-transform: none;
	-o-transform: none;
	transform: none;
}
</style>


</head>

<body>

<h1 id="toc_0">BlackEnergy y los <mark>sistemas críticos</mark></h1>

<blockquote>
<p><mark>Sistema Crítico</mark>: sistema que realiza cualquier actividad rigurosa en cuanto a cálculos, flujo de datos... Ejemplos típicos que se dan: un sistema de software de control de un cohete de la NASA, el sistema de gestión de una central nuclear. Un software que NO DEBE FALLAR (o al menos minimizar al máximo la posibilidad de errores).</p>
</blockquote>

<p>Ucrania ha sido recientemente atacada por malware cuyo objetivo ha sido sabotear los sistemas de control de las infraestructuras públicas. Varias distribuidoras eléctricas fueron comprometidas por el <mark>troyano</mark> BlackEnergy el 23 de diciembre, dejando a los hogares de la región ucraniana Ivano-Frankvisk (de una población alrededor de 1,5 millones de habitantes) sin electricidad.</p>

<blockquote>
<p><mark>Troyano</mark>: se trata de un tipo de virus que le da al atacante control total sobre la máquina infectada. Es como estar delante de ella, pero desde la comodidad de tu sofá en algún lugar del mundo.</p>
</blockquote>

<p>Sin embargo, este no ha sido el único caso de ataque ocurrido a sistemas de control en Ucrania, ya que a comienzos de este año se produjo un ataque a los sistemas informáticos del aeropuerto de Kiev con la intención de provocar caos y desconcierto tras la disrupción del servicio aéreo. Las noticias coinciden en que el malware detectado es similar a BlackEnergy, aunque en este caso se detectó en sus estados iniciales y pudo ser eliminado sin tener consecuencias. En noviembre de 2015  también se produjo otro ataque a cadenas de televisión y medios con características similares a los descritos.</p>

<h2 id="toc_1"> Descripción y evolución de BlackEnergy</h2>

<p>BlackEnergy ha evolucionado de ser un troyano a convertirse en una <mark>Amenaza Persistente Avanzada</mark> (APT - Advanced Persistent Threat). No se trata de una muestra de malware reciente; de hecho, su primera detección fue ya en el año 2007.</p>

<blockquote>
<p><mark>Amenaza Persistente Avanzada</mark>: básicamente, el atacante ya ha entrado en el sistema (en este caso, usando el troyano) y ha ido escalando privilegios en la máquina hasta el punto que ha abierto tal brecha en ella que tiene una puerta trasera (<em>backdoor</em>) por la que puede acceder fácilmente, aunque se elimine el troyano que le dio acceso inicialmente.</p>
</blockquote>

<p><img src="img/a.png" alt=""></p>

<p>Originariamente se diseñó como una herramienta para crear <mark>botnets</mark> con el objetivo de realizar ataques <mark>DDoS</mark>. El troyano consta de una aplicación que genera los clientes que el atacante usa para infectar las máquinas de sus víctimas. También provee scripts para llevar a cabo las DDoS que el atacante configura desde el <mark>servidor C&amp;C</mark> (Command and Control), así como una interfaz para controlar los equipos infectados.</p>

<blockquote>
<p><mark>Botnet</mark>: red de ordenadores infectados por una misma entidad o atacante con el fin de usarlos como intermediarios en conexiones o como un ejército de máquinas que usar para posibles ataques a otro objetivo (por ejemplo, un ataque DDoS).<br>
<mark>DDoS</mark>: <em>Distributed Denial of Service</em>. Un ataque en el que se pone un gran número de máquinas dispersas en cuanto a su distribución geográfica a realizar peticiones a la máquina víctima (por ejemplo, cargar una página web, es una petición). La máquina víctima, ante tal cantidad de peticiones, se queda sin recursos con los que responder (RAM, ancho de banda...) y el servicio que esté ofreciendo (posible página web o vía de comunicación) se cae y queda inutilizable.<br>
<mark>Servidor C&amp;C</mark>: easy peasy... la máquina desde la que el atacante toma control de las máquinas infectadas (botnet).</p>
</blockquote>

<p>Una propiedad significativa de este troyano es su capacidad de extenderse mediante componentes o plugins que pueden atacar <mark>otras plataformas (ARM)</mark> o funcionalidades como el robo de <mark>certificados</mark>. En su último ataque la extensión más utilizada fue el malware <mark>KillDisk</mark>.</p>

<blockquote>
<p><mark>Arquitectura ARM</mark>: <del>esto me ha dado miedo</del>. Es una arquitectura de hardware que solían usar dispositivos antiguos. Hoy día la usan dispositivos empotrados, tipo móviles corriendo Android.<br>
<mark>Certificado Digital</mark>: archivo con datos encriptados que despacha una entidad con autoridad para ello (<strong>CA</strong>, <strong>Certification Authority</strong>). Sirve como identificador para una entidad, ya sea una empresa o una persona individual. Algo así como un DNI digital.<br>
<mark>KillDisk</mark>: software que realmente se vende como una herramienta para eliminar por completo los archivos de cualquier sistema de almacenamiento: <a href="http://www.killdisk.com/">enlace a la página web</a>. Aunque, sirviendo para eso, no es difícil imaginar que se use para fines maliciosos...</p>
</blockquote>

<p><img src="img/b.png" alt=""></p>

<p>La segunda versión de este troyano incluye <mark>rootkits</mark> que amplían sus funciones para poder acceder de forma imperceptible al sistema. Esta nueva versión se detectó por primera vez en 2010.</p>

<blockquote>
<p><mark>RootKit</mark>: el término proviene de Linux. En Linux, el usuario con privilegios de administrador se suele llamar por defecto &quot;<em>root</em>&quot;. Un RootKit es un software malicioso que te da acceso de administrador a la máquina víctima, para conseguir lo que antes te he explicado: abrir un <em>backdoor</em> por el que acceder sin necesidad de troyano alguno.</p>
</blockquote>

<p>En el año 2014 surgen variaciones que limitan el <mark>modo kernel</mark> únicamente para la realización de la carga maliciosa o que directamente lo inhabilitan cargándolo mediante el proceso <mark>rundl32.exe</mark>, versión denominada BlackEnergy Lite. El uso en modo kernel dificultaba el proceso de ataque al tener que contrarrestar nuevas contramedidas de los sistemas operativas, como la firma de controladores o el arranque seguro, haciendo demasiado costosos este tipo de ataques.</p>

<blockquote>
<p><mark>Modo Kernel</mark>: un procesador ejecuta instrucciones básicas descritas por el código fuente de un programa. Dependiendo del tipo de instrucción (por sus privilegios en la máquina), el procesador tiene dos modos de ejecución: <em>Modo Usuario</em> y <em>Modo Kernel</em>. Con cualquier aplicación de usuario (Chrome, Word, iTunes...), el procesador ejecuta instrucciones en <em>Modo Usuario</em>; mientras que con instrucciones propias del sistema operativo en sí, ejecuta en <em>Modo Kernel</em>.<br>
<mark>rundll32.exe</mark>: (es <strong>rundll32.exe</strong>, no <del>rundl32.exe</del>). Archivo del sistema operativo de Windows. Realiza funciones de gestión, administración y ejecución de este. Lo puedes encontrar en <code>C:\Windows\system32\rundll32.exe</code>, en cualquier máquina corriendo Windows.</p>
</blockquote>

<p><img src="img/c.png" alt=""></p>

<p>En el año 2015, BlackEnergy agrega las <mark>variaciones Win32/KillDisk.NBB, Win32/KillDisk.NBC y Win32/KillDisk.NBD</mark> detectados por el CERT-UA, que incluyen el componente KilDisk. Esta es la versión utilizada en el ataque.</p>

<blockquote>
<p><mark>Variaciones <em>x</em>, <em>y</em>, <em>z</em></mark>: es la notación oficial que tienen las entidades de seguridad de software (empresas de antivirus, auditorías de seguridad...) para referirse a versiones de malware. Un mismo malware puede tener diferentes versiones, ligeramente modificadas para &quot;<em>des-arreglar arreglos</em>&quot; en el sistema víctima.</p>
</blockquote>

<h2 id="toc_2">Anatomía del ataque BlackEnergy</h2>

<h3 id="toc_3">Vías de infección</h3>

<p>El medio de infección ha sido principalmente el envío de correos electrónicos <mark>con documentos adjuntos</mark> suplantando al emisor, normalmente una autoridad (en este caso provenía de un partido político), que <mark>engañan al usuario</mark> para poder activar el ejecutable; o mediante <mark>exploits</mark> que de forma silenciosa propagan su instalación.</p>

<blockquote>
<p><mark>Payload en los documentos adjuntos</mark>: se puede <em>bindear</em> varios archivos en uno (unirlos para que parezcan uno solo). Al abrirlo, se abren todos los archivos bindeados en el primero. Si bindeas un payload malicioso (virus) a un <code>.pdf</code>, por ejemplo, al usuario se le abre el <code>.pdf</code> y de fondo, de manera silenciosa, se acaba de infectar con malware.<br>
<mark>Engañar al usuario</mark>: práctica de <u>ingeniería social</u>. Es una de las maneras más recurridas para atacar, las fallas de seguridad más gordas las presentan los propios individuos de la entidad, no las máquinas. Las personas confían por defecto... (que somos tontos, vaya).<br>
<mark>Exploit</mark>: se trata de un modo/vía de <del>explotar</del> usar una vulnerabilidad conocida en un software, consiguiendo acceso momentaneo a la máquina y pudiendo, a través de ello, cargar un <em>payload</em>, que vendría a ser la carga maliciosa (virus, troyano, rootkit, script...).</p>
</blockquote>

<p><img src="img/d.png" alt=""></p>

<p>También se encontró una versión que simulaba ser un instalador de Adobe Flash Player.</p>

<p>Los instaladores más usados del troyano BlackEnergy son nombrados como <mark>msiexec.exe</mark>.</p>

<blockquote>
<p><mark>msiexec.exe</mark>: el nombre tiene sentido. Existen diferentes maneras de crear instaladores de programas en Windows. Una de ellas es usar el formato <em>COM Structured Storage</em>, que es simplemente un archivo en que están ocultos todos los archivos a instalar, junto con las instrucciones de dónde instalarlos, etc. Estos archivos se suelen llamar <em>Instalador MSI</em>. <a href="http://www.advancedinstaller.com/">Ejemplo de un programa para crear instaladores</a>. El nombre <code>msiexec.exe</code> está intentando camuflar la finalidad del ejecutable, llamándose como algo bastante común: el instalador del propio sistema operativo, Windows.<br>
<mark>Dropper Malware</mark> (en la imagen): un software que no contiene en sí el payload malicioso, pero que se encarga, de descargarlo, en el momento en que esté programado para hacerlo, e instalarlo autómatica y silenciosamente. En el momento en que entra el dropper a la máquina víctima, no se detecta ninguna amenaza, pero ya está programada para instalarla en algún momento determinado.</p>
</blockquote>

<h3 id="toc_4">Vector de ataque</h3>

<p>En abril del 2014, una variación de BlackEnergy se aprovecha de una <mark>vulnerabilidad</mark> de Microsoft Word. Posteriormente se realizan campañas mediante archivos de Powerpoint, según la compañía ESET. Los análisis técnicos más recientes de BlackEnergy identificaron el aprovechamiento de vulnerabilidades críticas que afectaban a software ofimático de Microsoft a través de <mark>macros</mark> maliciosas. En concreto hace uso, al menos, de las vulnerabilidades CVE-2014-4114 (PowerPoint) y CVE-2014-1761 (Word), aunque también se han encontrado ficheros Excel utilizados para la infección.</p>

<blockquote>
<p><mark>Vulnerabilidad</mark>: fallo en cualquier software que se puede explotar para acceder a la máquina víctima.<br>
<mark>Macro</mark>: una macro es una combinación de teclas, ya sea pulsar varias a la vez o varias en serie, una después de otra. Existen programas que guardan macros y se pueden configurar para que se lancen automáticamente. Rollo: &quot;en Photoshop, para guardar el archivo en formato X, tienes que pulsar <code>ctrl+s, up, up, enter</code>&quot;, configuras esa combinación en el programa de macros y la vinculas a <code>ctrl+alt+s</code>; al pulsar <code>ctrl+alt+s</code> el programa simula la pulsación de la combinación inicial (que es más difícil de recordar o, simplemente, más larga). En este caso, supongo que sería una vulnerabilidad en un software que se activaría mediante alguna macro, y programaron un malware que ejecutaba esa macro de fondo, abriendo acceso a la máquina.</p>
</blockquote>

<h3 id="toc_5"> Operación</h3>

<p>El instalador se lanza por medio de documentos o aplicaciones manipuladas que contienen el troyano. En la última variante, utilizada para las instalaciones eléctricas ucranianas, no se ejecutaba el archivo msiexec.exe sino una macro con el nombre vba_macro.exe activada por un malware tipo dropper (ejecución de macros escondidas en el documento señuelo).</p>

<blockquote>
<p>Aquí ya no te tengo que explicar nada, no ? Hahahaha &lt;3</p>
</blockquote>

<p><img src="img/e.png" alt=""></p>

<p>La carga maliciosa del dropper es una <mark>DLL</mark> que es ejecutada por el proceso rundll32 y crea el <mark>archivo LNK</mark> que permite la persistencia tras el reinicio. En el proceso de carga se realizar la conexión con el servidor C&amp;C.</p>

<blockquote>
<p><mark>DLL</mark>: <em>Dynamic Link Library</em>, archivos <code>.dll</code>. Archivo que contiene código fuente compilado, listo para ejecutarse, al igual que un <code>.exe</code>, pero que no es el código principal de ningún programa, sino que el programa que sea (<code>.exe</code>), puede usar código de él para complementar su ejecución. Algo así como una biblioteca a la que los programas pueden acceder para ejecutar código de ellas, por eso se llaman <em>de vinculación dinámica</em>, porque acceden a ellas en tiempo real, cuando lo necesitan.<br>
<mark>Archivo LNK</mark>: en Windows, un archivo <code>.lnk</code> es un acceso directo a cualquier otro archivo o aplicación (<code>.exe</code>).<br>
En este último párrafo explica más o menos el funcionamiento de esta variante: un dropper descarga e instala una <code>.dll</code> que ejecuta el mismo <code>rundll32.exe</code> (que se ejecuta por el mismo Windows al iniciar el sistema operativo). Esta <code>.dll</code> maliciosa crea un <code>.lnk</code> del malware en sí, <u>supongo</u> que en la carpeta <code>C:\Users\&lt;YourUserName&gt;\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</code>. Cualquier acceso directo a aplicaciones en esta carpeta se ejecuta cuando se inicia el sistema operativo. Podrías por ejemplo, hacer que se abra iTunes cada vez que se encienda el PC, aunque en este caso era algo más malote. Y listo, este malware inicia conexión con el Server C&amp;C y el atacante ya tiene su vía de acceso configurada y lista para ser usada.</p>
</blockquote>

<p>Cuando el servidor está conectado, el malware envía <mark>peticiones POST</mark> con información de la víctima, solicitando diversos comandos.</p>

<blockquote>
<p><mark>Petición POST</mark>: es uno de los comandos que usa el protocolo de comunicación HTTP (el de las páginas web). <em>Representational State Transfer</em> (RESTful API): es un sistema de transferencia de datos basado en 4 comandos: <strong>GET</strong> (petición de datos), <strong>POST</strong> (envío de datos), <strong>PUT</strong> (almacenamiento de archivos) y <strong>DELETE</strong> (eliminación de archivos). <a href="https://en.wikipedia.org/wiki/Representational_state_transfer">Enlace a la página de Wikipedia de la API REST</a>.</p>
</blockquote>

<p><img src="img/f.png" alt=""></p>

<p>La versión de BlackEnergy analizada, soporta el uso de <mark>servidores proxy</mark> para conectarse a los servidores C&amp;C. Así, se posibilita su implantación en entornos en los que los usuarios finales necesitan de un proxy para poder tener acceso a Internet. Esta inclusión evidencia las intenciones de los criminales y su conocimiento previo sobre el objetivo. Se han recogido muestras de malware con servidor proxy asociado al ferrocarril ucraniano o dominios de ciudades como Dnipropetrovsk, la cuarta ciudad más importante de Ucrania.</p>

<blockquote>
<p><mark>Servidor Proxy</mark>: máquina que hace las veces de intermediario en la conexión entre otras dos máquinas. Puede filtrar información (como el proxy de la UMA, que no te deja conectarte a juegos, rechaza los datos de servidores del League of Legends, por ejemplo), modificarla, eliminar información o, simplemente, hacer de intermediario con el fin de ocultar la localización geográfica del usuario al otro extremo de la conexión.</p>
</blockquote>

<p>Tras la comunicación con el C&amp;C se descargan los <mark>módulos</mark> necesarios para el ataque. Concretamente, se descargaba el módulo KillDisk, que, a continuación busca dos procesos:</p>

<blockquote>
<p><mark>Módulo</mark>: componenetes o diferentes ejecutables maliciosos usados en un ataque.</p>
</blockquote>

<ul>
<li>Sec_service.exe: Asociado con el software ELTIMA Serial to Ethernet Connector o con ASEM Ubiquity, utilizados en los sistemas de control Industrial. En concreto el primero es un software que permite pasar del <mark>protocolo serie</mark> a <mark>Ethernet</mark> pudiendo así gestionarlo de forma más eficiente, y el segundo es un asistente software que permite gestionar las soluciones WinCE y Win32/64 de forma remota. Si el troyano encuentra este proceso en el sistema atacado no sólo lo cierra, sino que también lo sobrescribe con datos aleatorios dificultando así la restauración.</li>
<li>komut.exe: Archivo que contiene información importante de cómo un programa o un servicio debe ejecutarse. Su alteración puede afectar a otros programas y/o servicios que se estén ejecutando en el dispositivo.</li>
</ul>

<blockquote>
<p><mark>Protocolo Serie</mark>: un protocolo de transmisión de datos por cable usado en muuuuuuuchas máquinas antiguas. <a href="https://en.wikipedia.org/wiki/Serial_port">Los conectores eran estos</a>, te tienen que sonar seguro de algún PC antiguo, lo has tenigo que ver.<br>
<mark>Protocolo Ethernet</mark>: protocolo de transmisión de datos por cable que usan hoy día cualquier router. Son esas clavijas parecidas a las de teléfono, pero un poco más gruesas, por norma general, amarillas.</p>
</blockquote>

<p>Así, las funciones principales de KillDisk tienen como objetivo:</p>

<ul>
<li>Borrar archivos de sistema para que el re-arranque sea lo más difícil posible.</li>
<li>Borrar los eventos en el <mark>log de Windows</mark>.</li>
<li>Agregar la opción de introducir un retraso (delay) en la activación de una carga maliciosa (payload) destructiva.</li>
</ul>

<blockquote>
<p><mark>Log de Windows</mark>: base de datos local del sistema operativo de Windows en la que se guarda una lista de cualquier modificación o actividad que haya ocurrido en el sistema operativo. Algo así como un registro de actividad.</p>
</blockquote>

<p>Por tanto, se centra en borrar funcionalidades del sistema más que en el borrado de archivos (a diferencia de los ataques anteriores).</p>

<p>Mientras que las primeras versiones del troyano borraban alrededor de 4000 extensiones de ficheros, la versión usada en Ucrania se limita a solo 35.</p>

<p><img src="img/g.png" alt=""></p>

<h2 id="toc_6">Recomendaciones y prevención</h2>

<p>Las recomendaciones y buenas prácticas para protegerse del troyano BlackEnergy son:</p>

<ul>
<li>Uso de <mark>listas blancas</mark> de procesos, impidiendo la ejecución de procesos que hayan sido modificados.</li>
<li>Separación de entornos, utilizando un equipo para las tareas correspondientes a los sistemas de control (TO) y otro para las tareas de gestión correspondientes a los sistemas de información (TI).</li>
<li>Formación a los empleados y concienciación en seguridad sobre la utilización de determinado software y la apertura de ficheros provenientes de internet.</li>
<li>Actualización de los sistemas y aplicación de parches de seguridad para prevenir ataques de vulnerabilidades ya conocidas.</li>
<li>Actualización de las firmas de los antivirus y programas antimalware que puedan dar respuesta rápida a APT.</li>
<li>Uso de sistemas de gestión de eventos y monitorización del tráfico.</li>
</ul>

<blockquote>
<p><mark>Lista blanca</mark>: <em>Whitelist</em>. Lista con nombres de aplicaciones a las que SÍ se les permite ejecutarse. Si una aplicación intenta ejecutarse y no está en la whitelist... a tomar por culo con ella. Es como un reservado en una discoteca.</p>
</blockquote>

<p>Como complemento a estas medidas de carácter general y específicamente para detectar y prevenir el malware BlackEnergy, se recomienda hacer uso de las reglas de Yara y los indicadores de compromiso disponibles de forma pública.</p>

<h2 id="toc_7"> Infográfico</h2>

<p><img src="img/h.png" alt=""></p>



<script type="text/javascript">
var _self="undefined"!=typeof window?window:"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?self:{},Prism=function(){var e=/\blang(?:uage)?-(\w+)\b/i,t=0,n=_self.Prism={util:{encode:function(e){return e instanceof a?new a(e.type,n.util.encode(e.content),e.alias):"Array"===n.util.type(e)?e.map(n.util.encode):e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/\u00a0/g," ")},type:function(e){return Object.prototype.toString.call(e).match(/\[object (\w+)\]/)[1]},objId:function(e){return e.__id||Object.defineProperty(e,"__id",{value:++t}),e.__id},clone:function(e){var t=n.util.type(e);switch(t){case"Object":var a={};for(var r in e)e.hasOwnProperty(r)&&(a[r]=n.util.clone(e[r]));return a;case"Array":return e.map&&e.map(function(e){return n.util.clone(e)})}return e}},languages:{extend:function(e,t){var a=n.util.clone(n.languages[e]);for(var r in t)a[r]=t[r];return a},insertBefore:function(e,t,a,r){r=r||n.languages;var l=r[e];if(2==arguments.length){a=arguments[1];for(var i in a)a.hasOwnProperty(i)&&(l[i]=a[i]);return l}var o={};for(var s in l)if(l.hasOwnProperty(s)){if(s==t)for(var i in a)a.hasOwnProperty(i)&&(o[i]=a[i]);o[s]=l[s]}return n.languages.DFS(n.languages,function(t,n){n===r[e]&&t!=e&&(this[t]=o)}),r[e]=o},DFS:function(e,t,a,r){r=r||{};for(var l in e)e.hasOwnProperty(l)&&(t.call(e,l,e[l],a||l),"Object"!==n.util.type(e[l])||r[n.util.objId(e[l])]?"Array"!==n.util.type(e[l])||r[n.util.objId(e[l])]||(r[n.util.objId(e[l])]=!0,n.languages.DFS(e[l],t,l,r)):(r[n.util.objId(e[l])]=!0,n.languages.DFS(e[l],t,null,r)))}},plugins:{},highlightAll:function(e,t){var a={callback:t,selector:'code[class*="language-"], [class*="language-"] code, code[class*="lang-"], [class*="lang-"] code'};n.hooks.run("before-highlightall",a);for(var r,l=a.elements||document.querySelectorAll(a.selector),i=0;r=l[i++];)n.highlightElement(r,e===!0,a.callback)},highlightElement:function(t,a,r){for(var l,i,o=t;o&&!e.test(o.className);)o=o.parentNode;o&&(l=(o.className.match(e)||[,""])[1],i=n.languages[l]),t.className=t.className.replace(e,"").replace(/\s+/g," ")+" language-"+l,o=t.parentNode,/pre/i.test(o.nodeName)&&(o.className=o.className.replace(e,"").replace(/\s+/g," ")+" language-"+l);var s=t.textContent,u={element:t,language:l,grammar:i,code:s};if(!s||!i)return n.hooks.run("complete",u),void 0;if(n.hooks.run("before-highlight",u),a&&_self.Worker){var c=new Worker(n.filename);c.onmessage=function(e){u.highlightedCode=e.data,n.hooks.run("before-insert",u),u.element.innerHTML=u.highlightedCode,r&&r.call(u.element),n.hooks.run("after-highlight",u),n.hooks.run("complete",u)},c.postMessage(JSON.stringify({language:u.language,code:u.code,immediateClose:!0}))}else u.highlightedCode=n.highlight(u.code,u.grammar,u.language),n.hooks.run("before-insert",u),u.element.innerHTML=u.highlightedCode,r&&r.call(t),n.hooks.run("after-highlight",u),n.hooks.run("complete",u)},highlight:function(e,t,r){var l=n.tokenize(e,t);return a.stringify(n.util.encode(l),r)},tokenize:function(e,t){var a=n.Token,r=[e],l=t.rest;if(l){for(var i in l)t[i]=l[i];delete t.rest}e:for(var i in t)if(t.hasOwnProperty(i)&&t[i]){var o=t[i];o="Array"===n.util.type(o)?o:[o];for(var s=0;s<o.length;++s){var u=o[s],c=u.inside,g=!!u.lookbehind,h=!!u.greedy,f=0,d=u.alias;u=u.pattern||u;for(var p=0;p<r.length;p++){var m=r[p];if(r.length>e.length)break e;if(!(m instanceof a)){u.lastIndex=0;var y=u.exec(m),v=1;if(!y&&h&&p!=r.length-1){var b=r[p+1].matchedStr||r[p+1],k=m+b;if(p<r.length-2&&(k+=r[p+2].matchedStr||r[p+2]),u.lastIndex=0,y=u.exec(k),!y)continue;var w=y.index+(g?y[1].length:0);if(w>=m.length)continue;var _=y.index+y[0].length,P=m.length+b.length;if(v=3,P>=_){if(r[p+1].greedy)continue;v=2,k=k.slice(0,P)}m=k}if(y){g&&(f=y[1].length);var w=y.index+f,y=y[0].slice(f),_=w+y.length,S=m.slice(0,w),O=m.slice(_),j=[p,v];S&&j.push(S);var A=new a(i,c?n.tokenize(y,c):y,d,y,h);j.push(A),O&&j.push(O),Array.prototype.splice.apply(r,j)}}}}}return r},hooks:{all:{},add:function(e,t){var a=n.hooks.all;a[e]=a[e]||[],a[e].push(t)},run:function(e,t){var a=n.hooks.all[e];if(a&&a.length)for(var r,l=0;r=a[l++];)r(t)}}},a=n.Token=function(e,t,n,a,r){this.type=e,this.content=t,this.alias=n,this.matchedStr=a||null,this.greedy=!!r};if(a.stringify=function(e,t,r){if("string"==typeof e)return e;if("Array"===n.util.type(e))return e.map(function(n){return a.stringify(n,t,e)}).join("");var l={type:e.type,content:a.stringify(e.content,t,r),tag:"span",classes:["token",e.type],attributes:{},language:t,parent:r};if("comment"==l.type&&(l.attributes.spellcheck="true"),e.alias){var i="Array"===n.util.type(e.alias)?e.alias:[e.alias];Array.prototype.push.apply(l.classes,i)}n.hooks.run("wrap",l);var o="";for(var s in l.attributes)o+=(o?" ":"")+s+'="'+(l.attributes[s]||"")+'"';return"<"+l.tag+' class="'+l.classes.join(" ")+'" '+o+">"+l.content+"</"+l.tag+">"},!_self.document)return _self.addEventListener?(_self.addEventListener("message",function(e){var t=JSON.parse(e.data),a=t.language,r=t.code,l=t.immediateClose;_self.postMessage(n.highlight(r,n.languages[a],a)),l&&_self.close()},!1),_self.Prism):_self.Prism;var r=document.currentScript||[].slice.call(document.getElementsByTagName("script")).pop();return r&&(n.filename=r.src,document.addEventListener&&!r.hasAttribute("data-manual")&&document.addEventListener("DOMContentLoaded",n.highlightAll)),_self.Prism}();"undefined"!=typeof module&&module.exports&&(module.exports=Prism),"undefined"!=typeof global&&(global.Prism=Prism);
</script>

<script type="text/javascript">
!function(){"undefined"!=typeof self&&self.Prism&&self.document&&Prism.hooks.add("complete",function(e){if(e.code){var t=e.element.parentNode,s=/\s*\bline-numbers\b\s*/;if(t&&/pre/i.test(t.nodeName)&&(s.test(t.className)||s.test(e.element.className))&&!e.element.querySelector(".line-numbers-rows")){s.test(e.element.className)&&(e.element.className=e.element.className.replace(s,"")),s.test(t.className)||(t.className+=" line-numbers");var n,a=e.code.match(/\n(?!$)/g),l=a?a.length+1:1,m=new Array(l+1);m=m.join("<span></span>"),n=document.createElement("span"),n.className="line-numbers-rows",n.innerHTML=m,t.hasAttribute("data-start")&&(t.style.counterReset="linenumber "+(parseInt(t.getAttribute("data-start"),10)-1)),e.element.appendChild(n)}}})}();
</script>

<script type="text/javascript">
!function(){if("undefined"!=typeof self&&self.Prism&&self.document){var e={html:"HTML",xml:"XML",svg:"SVG",mathml:"MathML",css:"CSS",clike:"C-like",javascript:"JavaScript",abap:"ABAP",actionscript:"ActionScript",apacheconf:"Apache Configuration",apl:"APL",applescript:"AppleScript",asciidoc:"AsciiDoc",aspnet:"ASP.NET (C#)",autoit:"AutoIt",autohotkey:"AutoHotkey",basic:"BASIC",csharp:"C#",cpp:"C++",coffeescript:"CoffeeScript","css-extras":"CSS Extras",fsharp:"F#",glsl:"GLSL",http:"HTTP",inform7:"Inform 7",json:"JSON",latex:"LaTeX",lolcode:"LOLCODE",matlab:"MATLAB",mel:"MEL",nasm:"NASM",nginx:"nginx",nsis:"NSIS",objectivec:"Objective-C",ocaml:"OCaml",parigp:"PARI/GP",php:"PHP","php-extras":"PHP Extras",powershell:"PowerShell",jsx:"React JSX",rest:"reST (reStructuredText)",sas:"SAS",sass:"Sass (Sass)",scss:"Sass (Scss)",sql:"SQL",typescript:"TypeScript",vhdl:"VHDL",vim:"vim",wiki:"Wiki markup",yaml:"YAML"};Prism.hooks.add("before-highlight",function(s){var a=s.element.parentNode;if(a&&/pre/i.test(a.nodeName)){var t,i,r=a.getAttribute("data-language")||e[s.language]||s.language.substring(0,1).toUpperCase()+s.language.substring(1),l=a.previousSibling;l&&/\s*\bprism-show-language\b\s*/.test(l.className)&&l.firstChild&&/\s*\bprism-show-language-label\b\s*/.test(l.firstChild.className)?i=l.firstChild:(t=document.createElement("div"),i=document.createElement("div"),i.className="prism-show-language-label",t.className="prism-show-language",t.appendChild(i),a.parentNode.insertBefore(t,a)),i.innerHTML=r}})}}();
</script>


</body>

</html>
